from vuln_gatherer import VulnGatherer
from vuln_db import VulnDB
# from component_manager import ComponentManager

class VulnReturn():
    # Takes a list of comonents and checks each one for most recent CVE
    # Function component_manager.py componentManager lookup_component
    # returns entire table comp_type, comp_version, comp_name
    # return vulns from the last year
    # returns top 25/50/100 vulns and display it as active tick box in a nother colum


    # Looks up project names, and then look up components

    #Run all vuln gathers and returns the lists
    #
    # def vuln_lists(self, search_term):
    #     VG = VulnGatherer()
    #     vuln_list1 = VG.vulners_com(search_term)
    #     vuln_list2 = VG.CVE_org(search_term)
    #     return vuln_list1, vuln_list2

    def return_recent_CVE(self, search_term):
#        try:
        VG = VulnGatherer()
        two_lists = VG.CVE_org(search_term)
        CVEs = two_lists[0]
        return CVEs[0]
    # except:
            # return "No results have been found"

    def return_recent_description(self, search_term):
        # try:
        VG = VulnGatherer()
        two_lists = VulnGatherer().CVE_org(search_term)
        description = two_lists[1]
        return description[0]
        # except:
        #     return "No results have been found"

    def recent_vuln_db(self, search_term, project_name):# Only adds the most recent CVE vulns
        # print(search_term)
        #project_name = VulnDB.lookup_components()
        recent_cve = self.return_recent_CVE(search_term)
        recent_description = self.return_recent_description(search_term)
        # print(project_name)
        return VulnDB().add_new_vuln(search_term, recent_cve, recent_description, project_name)

    def return_amount_CVE(self, search_term):
#        try:
        VG = VulnGatherer()
        Amount = VG.read_results_amount()
        two_lists = VG.CVE_org(search_term)
        CVEs = two_lists[0]
        return CVEs[:Amount]
    # except:
            # return "No results have been found"

    def return_amount_description(self, search_term):
        # try:
        VG = VulnGatherer()
        Amount = VG.read_results_amount()
        two_lists = VulnGatherer().CVE_org(search_term)
        description = two_lists[1]
        return description[:Amount]
        # except:
        #     return "No results have been found"

    def amount_vuln_db(self, search_term, project_name):# Only adds the most recent CVE vulns
        recent_cve = self.return_amount_CVE(search_term)
        recent_description = self.return_amount_description(search_term)
        # print(project_name)
        # VulnDB().add_new_vuln(search_term, recent_cve[1], recent_description[1], project_name)
        i = 0
        print(len(recent_cve))
        while i < len(recent_cve):
            print(i)
            CVE = recent_cve[i]
            Description = recent_description[i]
            search_term = str(search_term)
            project_name = str(project_name)
            # self.return_amount_CVE(search_term)[i]
            # self.return_amount_description(search_term)[i]
            VulnDB().add_new_vuln(search_term, CVE, Description, project_name)
            i += 1
    # borrow check estistence & create user functions if it isn't in the DBB add it
    # check CVE number for new update
    #
    # Making sure not to print the same CVE from different sources


    # def comp_to_vuln():# takes the information in comp DB and put in a format to be put into a search
    #     CM = ComponentManager()
    #     comp_db = CM.lookup_component()
    #     comp_type_list=[]
    #     comp_version_list =[]
    #     comp_name_list=[]
    #
    #     for item in comp_db:
    #         comp_type_list.append(item["comp_type"])
    #         comp_version_list.append(item["comp_version"])
    #         comp_name_list.append(item["comp_name"])
    #
    #     search_term = comp_name_list[0] + comp_version_list[0]
    #     self.recent_vuln_db(search_term)

    def list_vuln_search(self, project_name):#takes in a list of components to search through
        list = VulnDB().lookup_components(project_name)
        # print(list[0])
        for item in list[0]:
            # print(item + project_name)
            #self.recent_vuln_db(item, project_name)
            self.amount_vuln_db(item, project_name)




    # def send_project_name(self, project_name):
    #     return project_name

    # def add_components_vulns_DB(self):#Takes the list outputed by look up and add vulns to the db
    #     # components_list = self.lookup_component(project_name)
    #     VR = VulnReturn()
    #     self.send_project_name(project_name)
    #     VR.list_vuln_search(components_list)#takes the components from a projects and adds the vulns to the db
    #     return "The vulnerbilities are being searched and added to your project"

#
# list_comp = ["java", "Python 3.9", "Windows 10", "cisco", "dell"]
print(VulnReturn().list_vuln_search("project1")) # Only seems to be getting one resut from the webscrapper
# print(VulnReturn().return_amount_CVE("Windows 10"))
# print(VulnReturn().return_amount_description("Windows 10"))
# print(VulnReturn().recent_vuln_db("java"))
# print(VulnReturn().return_recent_CVE("kali"))
# print(VulnReturn().return_recent_description("kali"))
